name: CI and Deploy

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "PATH=$HOME/.local/bin:$PATH" >> $GITHUB_ENV
      - name: Backend tests
        working-directory: backend
        run: |
          uv sync --all-extras
          uv run pytest
      - name: Frontend tests
        working-directory: frontend
        run: |
          npm install
          npm run test -- --run

  deploy:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: us-central1
      BACKEND_SERVICE: n8n-backend
      FRONTEND_SERVICE: n8n-frontend
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - name: Configure Docker auth
        run: gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet
      - name: Build and push backend image
        run: |
          BACKEND_IMAGE=${REGION}-docker.pkg.dev/${PROJECT_ID}/n8n/backend:${GITHUB_SHA}
          docker build -f infra/backend.Dockerfile -t $BACKEND_IMAGE .
          docker push $BACKEND_IMAGE
          echo "BACKEND_IMAGE=$BACKEND_IMAGE" >> $GITHUB_ENV
      - name: Build and push frontend image
        run: |
          FRONTEND_IMAGE=${REGION}-docker.pkg.dev/${PROJECT_ID}/n8n/frontend:${GITHUB_SHA}
          docker build -f infra/frontend.Dockerfile -t $FRONTEND_IMAGE .
          docker push $FRONTEND_IMAGE
          echo "FRONTEND_IMAGE=$FRONTEND_IMAGE" >> $GITHUB_ENV
      - name: Run migrations
        run: |
          gcloud run jobs execute n8n-migrations --wait || echo "Define Cloud Run job for migrations"
      - name: Deploy backend
        run: |
          gcloud run deploy $BACKEND_SERVICE --image $BACKEND_IMAGE --region $REGION --allow-unauthenticated --set-env-vars "DATABASE_URL=${{ secrets.CLOUD_SQL_PROXY_URL }},N8N_WEBHOOK_URL=${{ secrets.N8N_WEBHOOK_URL }}"
      - name: Deploy frontend
        run: |
          gcloud run deploy $FRONTEND_SERVICE --image $FRONTEND_IMAGE --region $REGION --allow-unauthenticated --set-env-vars "VITE_API_BASE_URL=${{ secrets.FRONTEND_API_URL }}"
